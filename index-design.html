<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Chunkchain - Blockchain Try Out</title>
  <link href="style.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script>
	let fnScope = null;
    function log(message) {
		console.log(message);
      //document.getElementById("log").textContent += message + "\n";
    }
  </script>
  <script src="https://chr15m.github.io/bugout/bugout.min.js" type="application/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script src="https://momentjs.com/downloads/moment.js"></script>
  <script src="./logic.js"></script>
  
</head>
<body ng-app="chunkchain">
	<script>
		angular.module('chunkchain', [])
		  .controller('ChatController', ['$scope', function($scope) {
			$scope.activityIndicator = true;
			$scope.selectedConversation = 'all';
			$scope.activeConversations = [
				'all',
				//'kürbis_123',
				//'minion99'
			]
			$scope.tokenPerMessage = 1;
			$scope.currentMessage = "";
			$scope.feedNews = [
				/*{
					'type': '+',
					'actor': 'minion99'
				},
				{
					'type': 'M+',
					'actor': 'kürbis_123'
				},
				{
					'type': 'B',
					'actor': 'minion99',
					'n': 5
				}*/
			];
			$scope.messagesList = [
				/*{
					'd': 'r', // direction - recieving
					'm': 'Hallo, wie geht\'s dir?'
				},
				{
					'd': 's', // direction - sending
					'm': 'Soweit, ganz gut. Und selber?'
				},
				{
					'd': 'r', // direction - recieving
					'u': true // unspend transaction
				},*/
			];
			$scope.activityHasChanged = function() {
			  	console.log($scope.activityIndicator);
			};
			$scope.conversationSelected = function(sSelectedItem) {
				console.log(sSelectedItem);
				$scope.selectedConversation = sSelectedItem;
			};
			$scope.feedItemSelected = function (sFeedItem) {

			};
			$scope.newParticipant = function (sNickname) {
				$scope.activeConversations.push(sNickname);
				$scope.feedNews.push({
					'type': '+',
					'actor': sNickname
				});
			};
			$scope.participantLeft = function (sNickname) {
				$scope.activeConversations.remove(sNickname);
				$scope.feedNews.push({
					'type': '-',
					'actor': sNickname
				});
			};
			$scope.newMessage = function (sNickname) {
				$scope.activeConversations.push(sNickname);
				$scope.feedNews.push({
					'type': 'MSG',
					'actor': sNickname
				});
				$scope.msgArrived();
			};
			$scope.blockFound = function (sNickname, bSelfFlag, iMessages, sNonce) {
				if (bSelfFlag) {
					$scope.feedNews.push({
						'type': 'S',
						'nonce': sNonce
					});
				}
				else {
					$scope.feedNews.push({
						'type': 'B',
						'actor': sNickname,
						'n': iMessages
					});
				}
				$scope.msgArrived();
			};
			$scope.msgArrived = function () {
				$scope.messagesList = aBlockchain.map(block => block.l)
										.flat().filter(tx => tx.r === $scope.selectedConversation)
										.map(tx => {
											return {
												'd': (getNickname(tx.s) === sUserNickName) ? 's' : 'r', // direction - recieving
												'm': tx.m
											}
										}).concat(
											oBlock.l.filter(tx => tx.r === $scope.selectedConversation)
											.map(tx => {
												return {
													'd': (getNickname(tx.s) === sUserNickName) ? 's' : 'r', // direction - recieving
													'u': true
												}
											})
										);
			}
			$scope.onEnter = function (e) {
				e.preventDefault();
				sendMessage($scope.currentMessage);
				$scope.currentMessage = "";
			};
			fnScope = $scope;
		  }]);

		  window.onload = () => {
			//const oAngularScope = angular.element(document.body).scope();
			console.log(fnScope);
			console.log(fnScope.activeConversations);
		  }


	  </script>
    <div class="header">
        <img src="assets/ChunkChain_Logo.svg" width="200px" />

        <div class="header_items">
            <a>zur Blockchain-Ansicht</a>
            <span>dein Kontostand: <b>100 Token</b></span>
        </div>
    </div>

    <div class="main_body" ng-controller="ChatController">
        <h1 class="page_title">Chat</h1>
        <p class="introduction_section">
Aktuell nutzen wir eine <b>public blockchain</b> (jeder darf schreiben und lesen) und speichern <b>on-chain</b> (alle Daten in der Blockchain). <br />
Damit kannst du aktuell jede Nachricht lesen, die jemand in diesem Netzwerk schickt.
        </p>

        <div class="chat_container">
            <div class="chat_window">
                <div class="conversations_container">
					<p ng-repeat="convo in activeConversations" class="conversation {{ convo === selectedConversation ? 'selected' : '' }}" data-letters="{{ convo.substr(0, 1).toUpperCase() }}" ng-click="conversationSelected(convo)">
						{{ convo }}
					</p>
				</div>
				<div class="messages_container">
					<div ng-repeat="message in messagesList" class="message {{ message.d === 's' ? 'sent' : '' }} {{ message.u ? 'unspend' : '' }}">
						{{ message.u ? "warten auf Nachricht..." : message.m }}
					</div>
				</div>
            </div>
            <div class="background_activity">
				<h3 class="minor_title">Aktivitäten im Netzwerk</h3>
				<div class="switch_container">
					<span class="{{ !activityIndicator ? 'switch_selected' : '' }}">alle</span>
					<label class="switch">
						<input type="checkbox" ng-model="activityIndicator" ng-change="activityHasChanged()">
						<span class="slider"></span>
					</label>
					<span class="{{ activityIndicator ? 'switch_selected' : '' }}">nur meine Aktivitäten</span>
				</div>
				<div class="activity_feed">
					<div class="activity_item" ng-repeat="feedItem in feedNews.reverse()" ng-click="feedItemSelected(feedItem)">
						<div ng-if="feedItem.type == '+' ">
							<b>{{ feedItem.actor }}</b> ist dem Netzwerk beigetreten.
						</div>
						<div ng-if="feedItem.type == '-' ">
							<b>{{ feedItem.actor }}</b> hat das Netzwerk verlassen.
						</div>
						<div ng-if="feedItem.type == 'M+' ">
							<b>{{ feedItem.actor }}</b> sucht jetzt auch nach Blöcken (mining).
						</div>
						<div ng-if="feedItem.type == 'M-' ">
							<b>{{ feedItem.actor }}</b> hat die Suche nach Blöcken aufgegeben.
						</div>
						<div ng-if="feedItem.type == 'B' ">
							<b>{{ feedItem.actor }}</b> hat einen neuen Block gefunden für <b>{{ feedItem.n }}</b> Nachrichten.
						</div>
						<div ng-if="feedItem.type == 'S' ">
							Du hast einen Block gefunden. <b>{{ feedItem.nonce }}</b> ist die Lösung
						</div>
						<div ng-if="feedItem.type == 'MSG' ">
							<b>{{ feedItem.actor }}</b> hat eine Nachricht geschrieben.
						</div>
					</div>
				</div>
				
			</div>
			<div class="chat_window_footer">
				<div class="chat_window_footer_new_chat_container">
					<button class="button">neuer Chat</button>
				</div>
				<div class="chat_window_footer_message">
					<input type="number" size="2" maxlength="2" ng-model="tokenPerMessage" />
					Token
					<div class="flexible_grow"></div>
					<form ng-submit="onEnter($event)">
						<input type="text" size="50" maxlength="300" placeholder="Nachricht..." ng-model="currentMessage" />
						<button class="button" [disabled]="currentMessage !== ''">senden</button>
					</form>
				</div>
			</div>
		</div>
		
    </div>

</body>
</html>
